name: Analyse OWASP ZAP (Stable & Fonctionnel)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  zap_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        run: |
          npm install
          mkdir -p db

      - name: Start Server
        run: nohup npm start > server.log 2>&1 &

      - name: Wait for server
        run: |
          echo "Attente du serveur..."
          sleep 10
          curl -I http://localhost:3000

      # ——————————————————
      # INSTALLATION OFFICIELLE ZAP CLI
      # ——————————————————
      - name: Download OWASP ZAP
        run: |
          wget https://github.com/zaproxy/zaproxy/releases/download/v2.15.0/ZAP_2.15.0_Linux.tar.gz
          tar -xvzf ZAP_2.15.0_Linux.tar.gz
          ls -la

      - name: Run ZAP Baseline Scan
        run: |
          ./ZAP_2.15.0/zap-baseline.py \
            -t http://localhost:3000 \
            -r zap_rapport.html \
            -w zap_rapport.txt \
            -I || true

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: rapports_zap
          path: |
            zap_rapport.html
            zap_rapport.txt
            server.log
